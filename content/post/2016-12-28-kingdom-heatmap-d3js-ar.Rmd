---
title: 'ุงููุซุงูุฉ ุงูุณูุงููุฉ: ุฎุงุฑุทุฉ ุญุฑุงุฑูุฉ ููููููุฉ ุจุฅุณุชุฎุฏุงู D3.js ู R'
author: 'Hussain'
date: '2020-02-21'
slug: kingdom-heatmap-d3js-ar
categories: []
tags:
  - ุฌููุบุฑุงูู
  - ุชูุงุนูู
---
```{r,include=FALSE,echo=FALSE,eval=FALSE,message=FALSE,warning=FALSE}
# RUN THIS CODE to ensure the article is reproducible
if("checkpoint" %in% installed.packages()['Package']){
  install.packages("checkpoint")
}else{
  cat("checkpoint exists - ready to create reproducible envirnoment")}

library("checkpoint")
checkpoint("2020-02-21")
```
### ููุฏูุฉ 
ูู ูุฐุง ุงูููุงู ุณูุชุญุฏุซยุนู ุฌุงูุจ ููู ูู ุฌูุงูุจ ุชุญููู ุงูุจูุงูุงุช ููู[ ุชุตููุฑ ุงูุจูุงูุงุช (Data Visualization)](https://ar.wikipedia.org/wiki/ุชุตููุฑ_ุจูุงูุงุช). ููุงูุนุงุฏุฉ ุณูู ูุชุฌูุจ ุงูุณุทุญูุฉ ูู ุงูุทุฑุญ ูุฐูู ุฑุงุญ ูุฑูุฒ ุนูู ูุณู ูุญุฏุฏ ูู ุชุตููุฑ ุงูุจูุงูุงุช ูู ูุชููู ูุน ุฅุฑูุงู ูุซุงู ุชุทุจููู ููููุถูุน. ููุงููุง ุณูู ูุณุชุนุฑุถ โุชุตููุฑ ุงูุจูุงูุงุช ุงูุฌุบุฑุงููุฉ ุงูููุงููุฉโ ุงู ูุง ูุนุฑู ุจุงูู [(Geovisualization)](https://en.wikipedia.org/wiki/Geovisualization). ูุฐุง ุงููุทุงู ูู ุชุตููุฑ ุงูุจูุงูุงุช ุงุฒุฏุงุฏุช ุดุนุจูุชู ุจุดูู ูุจูุฑ ูู ุงูุขููุฉ ุงูุฃุฎูุฑุฉ. ุญูุซยุจุฏุฃุช ุงููุซูุฑ ูู ุงูุดุฑูุงุช ูุงููุคุณุณุงุช ูุงูุญูููุงุช ุชุนุชูุฏู ูู ุตูุน ุงููุฑุงุฑ.ยูุง ุชุฑู ููุงุฐุงุ

ุงูู ุณุจุจ ูุนูุฏ ุฅูู ููุทุฉ ุจุณูุทุฉุ ููู ุฑุบู ุงูุชูุฏู ุงูุชููููุฌู ุฅูุง ุฃู ุงูุฅุฏุงุฉ ุงููุฃูููุฉ ุฌุฏุง ุจููุช ููุณูุง ููู ุงูุฎุงุฑุทุฉ. ููุฐ ููุง ุตุบุงุฑ ูุงู ูุฏููุง ุฎุงุฑุทุฉ ุงูููุฒ ุซู ูุจุฑูุง ูููู ู ุจุฏุฃูุง ูุชุงุจุน ุงุญูุงู ุงูุทูุณ ุจุงููุธุฑ ููุฎุงุฑุทุฉ ุนูู ุงูุชููุฒูููย ุซู ูุตู ุจูุง ุงูุฃูุฑ ุฃูู ุจุฅููุงู ุงู ููุง ุฅุฑุณุงู ูููุนู ุงูุญุงูู ุนุจุฑ ุจุฑุงูุฌ ุงูุชูุงุตู (ููุซุงู WhatsApp). ุงูุนุงูู ุงููุดุชุฑู ุจูู ูู ุชูู ุงููุฑุงุญู ูู ุฃู ุงูุฎุงุฑุทุฉ ูู ุจุทูุฉ ุงููููู.
ูุจู ุฃู ูุจุฏุฃ ูู ุงูููุถูุน ุฃุญุจ ุงู ุงุดูุฑ [ุงูุฃุฎ ุฃุณุงูุฉ](https://twitter.com/OAlotaik) ุนูู ุญูุงุฑู ูุนู ุญูู ููููุฉ ุงูุญุตูู ุนูู ูููุงุช ุงูุฎุฑุงุฆุท ุงูุจูุงููุฉ ูุชุตููุฑูุง. ุฃูุถุง ุฏุงูุน ุขุฎุฑยููุฐุง ุงูููุงู ูู ุฃูู ุฎูุงู ุฒูุงุฑุชู ยููุฑูุงุถ ยูู ุดูุฑ ููููุจุฑ ุญุถุฑุช [ูุคุชูุฑ ุงูุจูุงูุงุช ุงูุถุฎูุฉ](http://web.archive.org/web/20161029230013/http://events.kacst.edu.sa/ar/IT16/Pages/topic.aspx).ยููุงู ูุงู [ุงูุฏูุชูุฑ ุขูุณ ุงููุงุฑุณ](https://twitter.com/afalfaris)ยุจุนุฑุถยุฃุญุฏ ุงุจุญุงุซ ูุฑูุฒ ุงูููู ุนุจุฏ ุงูุนุฒูุฒ ููุชูููุฉ ูุงูุฐู ูุงู ูุชูุงูู [ููุถูุน ุชุญููู ูุชุตููุฑ ููุจูุงูุงุช ุจุฌููุน ุงุตุนุฏุชูุง ููุฏููุฉ ุงูุฑูุงุถ](https://www.kacst.edu.sa/arb/RD/Pages/content.aspx?dID=26).

### ุงููุฏู
ูุฏููุง ุงูููู ุจุณูุท ูููุงุณููู ููู ุชุตููุฑ ุงููุซุงูุฉ ุงูุณูุงููุฉ ูู ุงูููููุฉ ุญุณุจ ุงูููุงุทู ุงูุฅุฏุงุฑูุฉ ุงูุซูุงุซุฉ ุนุดุฑ ุจุทุฑููุฉ ุฎุงุฑุทุฉ ุญุฑุงุฑูุฉ. ุจุงูุฅุถุงูุฉ ุฅูู ุฐููุ ูุฑูุฏ ุงู ุชููู ุชูู ุงูุฎุงุฑุทุฉ ุชูุงุนููุฉ ุงูุถุง.

#### ุงูุฃุฏูุงุช ุงููุณุชุฎุฏูุฉ ู ุงูููุงุฑุงุช ุงููุทููุจุฉ
ุงููุงุฆูุฉ ุงูุชุงููุฉ ูู ูุฌููุนุฉ ูู ุงูุฃุฏูุงุช ุงูุชู ุงุณุชุฎุฏูุชูุง ูุชุตููู ุงูุฎุงุฑุทุฉ ุงูุชูุงุนููุฉ. ุงูุฅููุงู ุจูุง ููู ุจุดูู ุจุณูุท ูู ุฃูุฑ ุขุฎุชูุงุฑู ููููู ุณูุณุงุนุฏูยูุซูุฑุง ุฅููยููู ุงูููุฏ ู ุทุฑููุฉ ุชุตููู ุงูุฎุงุฑุทุฉ.

1. R
2. JavaScript
3. HTML
4. D3.js
5. TopoJson.js
6. Data :ยShapefiles, excel


#### ุงููุตุงุฏุฑ:
ูุฑุณู ูุฐู ุงูุฎุฑูุทุฉ ุงุณุชุนูุช ุจุงููุตุงุฏุฑ ุงูุชุงููุฉ

- [ ุงูููุฆุฉ ุงูุนุงูุฉ ููุฅุญุตุงุก](https://www.stats.gov.sa/sites/default/files/twzy_lskn_fy_lmnzq_ldry.xlsx)
- [ููุฆุฉ ุงููุณุงุญุฉ ุงูุฌููููุฌูุฉ ุงูุณุนูุฏูุฉ](https://sgs.org.sa)
- ูููุน [ Global Administration Areas](http://gadm.org/country)
- ูุชุงุจ [Learning D3.js Mapping](https://www.amazon.com/Learning-D3-js-Mapping-Thomas-Newton-ebook/dp/B00RP13CPC/ref=dp_kinw_strp_1) 
- ุชูุซูู [D3.js Documentation](https://github.com/d3/d3/wiki)

### ุฎุทุฉ ุงูุนูู

1. ุฌูุน ุงูุจูุงูุงุช ุงููุทููุจุฉ ููู (ุงูุจูุงูุงุช ุงูุฌููุบุฑุงููุฉ ููููููุฉ ุนูู ุงููุณุชูู ุงูููุงุทู ุงูุฅุฏุงุฑูุฉุย ุนุฏุฏ ุณูุงู ุงูููููุฉ ุนูู ูุณุชูู ุงูููุงุทู ุงูุฅุฏุงุฑูุฉุ ูุณุงุญุงุช ุงูููุงุทู ุงูุฅุฏุงุฑูุฉ)
2. ุฏูุฌ ุงูุจูุงูุงุช ูู ูููุงุช ุจุชูุณููย TopoJson
3. ุชุตููู ุงูุฎุฑูุทุฉ ูุชููุฆุชูุง ูุชุตููุฑ ุงูุจูุงูุงุช
4. ูู ุงูุฌุฏูุฑ ุจุงูุฐูุฑ ูู ุฃู ุฑุบู ุจุณุงุทุฉ ุงูุฎุฑูุทุฉ ุงูุชู ุณูุตูููุง ุฅูุง ุฃูู ุจุฏุงูุฉ ุฌูุฏุฉ ูุดูู ูุนูููุงุช ุฃุฎุฑู ูู ุงูุฎุงุฑุทุฉ (ูุซุงู: ุนุฏุฏ ุงูุฐููุฑ ูุงูุฅูุงุซ ููู ููุทูุฉ ุญุณุจ ุงูุฌูุณูุฉ).

### ุฌูุน ุงูุจูุงูุงุช

ุจุฅููุงููุง ุงูุญุตูู ุนูู ุจูุงูุงุช ุนุฏุฏ ุงูุณูุงูย ููู ููุทูุฉ ุจุชูุงุตูููุง ูู ูููุน ุงูููุฆุฉ ุงูุนุงูุฉ ููุฅุญุตุงุก ูุฐูู ูููููุง ุงูุญุตูู ุนูู ูุณุงุญุฉ ูู ููุทูุฉ ูู ุงูููููุฉ ูู ูููุน ููุฆุฉ ุงููุณุงุญุฉ ุงูุฌููููุฌูุฉ ุงูุณุนูุฏูุฉ. ูู ูุง ุชุจูู ููุง ููุง ูู ุงูุญุตูู ุนูู ููู ุงูุฎุงุฑุทุฉ ุงูุฑููู ุจุตูุบุฉ shapefiles ูุฐูู ูุชููุฑ ุนูู ูููุน Global Administration Areas ุงููุฌุงูู. ูุฐุง ูู ูุง ูุชูุฌุจ ุนูููุง ูุนูู ูู ูุงุญูุฉ ุฌูุน ุงูุจูุงูุงุช

### ุชูููุญ ูุฏูุฌ ุงูุจูุงูุงุช

ููุง ุชูุงุญุธุ ุงูุจูุงูุงุช ุงูุชู ุญุตููุง ุนูููุง ูุชูุฑูุฉ ููุตุงุฏุฑูุง ู ุตูุบ ูููุงุชูุง ูููุง ูุฎุชููุฉ. ูุฐูู ูุฌุจ ุนูููุง ุชูููุญูุง ูุฏูุฌูุง ูู ููู ุฐู ุตูุบุฉ ููุถูุฉ ูุฏููุง ูุณูู ุงูุชุนุงูู ูุนูุง. ุญุงููุง ูุฏููุง ุงููููุงุช ุงูุชุงูู
- ููู ุงูุณู ูู ูููุน ููุฆุฉ ุงูุฅุญุตุงุก. (ูุฐู ุงููููุงุช ูุจูุฑุฉ ูู ุงูุนุงุฏุฉ. ุขูุถุง โุนูููุฉโ ุนูุฏูุง ูุฃุชู ุงูุฃูุฑ ุฅูู ูุถุนูุง ุนูู ุงูููุจ)
- ููู ุดูุจ ูุงูู shapfiles ููู ุงูุฎุฑูุทุฉ ุงูุฑูููุฉ ููููููุฉ (ูุฐุง ุงูููู ุงูุถุง โุนูู ุนููู ูุฑุงุณูโ ููู ุงูุตูุบุฉ ุงููุนุชุฑู ุจูุง ุนุงูููุง ูู ุงูุฎุฑุงุฆุท ุงููุนูููุงุชูุฉ ูููููย ุงูุถุง โุนูููโ ูุน ุงูุฅูุชุฑูุช ูุญุฌูู ุงููุจูุฑ ุฌุฏุง)
- ููู ุงูุณู ูู ูููุน ููุฆุฉ ุงููุณุงุญุฉ ุงูุฌููููุฌูุฉ ( ููุณ ุงูููุงู ุนู ูููุงุช ุงูุฃูุณู)



ุจูุง ุฃููุง ุณูู ูุชุนุงูู ูุน d3.js ูุฌุจ ุนูููุง ูุนุฑูุฉ ุงู ุงูุตูุบ ุงูุชู ุชูุจููุง ููุชุจุฉ d3. ูู ูุฐู ุงูุญุงูุฉ ุงูุตูุบุฉ ูู GeoJSON ููู ุงูุถุง ุตูุบุฉ ุจุฏุฃุช ุชููู ุดุนุจูุชูุง ุจุดูู ูุจูุฑ. ููู ุงููุดููุฉ ููุง ูู ุฃู ูุฐู ุงูุตูุบุฉ ุงูุถุง ุซูููุฉ ุงููุฒู. ุทุจุนุง ุณุจุจ ุงูููุฉ ุญุฌู ุงูููู ุจุงููุณุจุฉ ููุง ูู ุฅูุนูุงุณยุงูุฃุฏุงุก ุนูู ุชุฌุฑุจุฉ ุงูุฒุงุฆุฑูู ูููููุน (ุชุฎูู ุชูุชุธุฑ ุฎูุณ ุฏูุงูู ุนูุดุงู ุชุดุงูุฏ ุงูุฎุฑูุทุฉุุ). ุจุณ ููุง ููููุย ุฑุงุญ ูุณุชุฎุฏู ุฅุณุชุฑุงุชูุฌูุฉ ุงุจุฏุงุนูุฉ ูุชูุงุฏู ูุฐู ุงููุนุถูุฉ ูููุง.
ย
ุงูุฅุณุชุฑุงุชูุฌูุฉ: ูุฏูุฌ ุงููููุงุช ูููุง ููุทูุนูุง ุนูู ุตูุบุฉ TopoJSON ููู ุตูุบุฉ ุฎูููุฉ ุฌุฏุง (ุชุฎุชุตุฑ ููุง ูจููช ูู ุญุฌู ุงูููู ุงูุฃุตูู). ุจุนุฏ ุฑูุน ุงูููู ุงูุตุบูุฑ ุนูู ุงููููุน ูููู ุจุชุญููููุง ุฅูู GeoJSON ุจุฅุณุชุฎุฏุงู ุฌุงูุง ุณูุฑูุจุช ูุงูุชู ุชุณุชุฎุฏู ุงูููุฉ ุงูุญุงุณูุจูุฉ ูููุณุชุฎุฏู ููุณู (client-side) โฆ ููุช ูู ุงุจุฏุงุน ๐
ุงุฎุชุตุงุฑ ูููุงุช ุงูุฃูุณู ูู ููู CSV ูุชุญุถูุฑูุง ููุฏูุฌ

ุชุญููู ููู shape files ุฅูู TopoJSONย ูุชุญุถูุฑูุง ููุฏูุฌ. ููุนู ุฐูู ููููยุนููย Terminal ยุจุชูุตูุจ ุจุนุถ ุงูุญุฒู ุงููุณุงุนุฏุฉ

```{bash,eval=FALSE}
sudo apt-get npm sudo npm install topojson@1.6.27 -g
```


ุชุญููู ุงููููุงุช


```{bash,eval=FALSE}
topojson -o SAU0.json -p -- SAU_adm1.shp
```

ุฏูุฌ ุงููููุงุช ุจุฅุณุชุฎุฏุงู ุฑูุฒ ุงูููุทูุฉ
```{bash,eval=FALSE}
topojson -o SAU_adm1.json -e PopulationData.csv --id-property=Region_ID,ID_1 -p -- SAU0.json
```

ุงูุขู ุงูููู ุฌุงูุฒ ูุฑูุนู ุนูู ุงูููุจุ ุฅุฐุง ูุง ุฒุจุทุช ูุนุงู ุงูุฎุทูุงุช ุงูุณุงุจูุฉ ุจุฅููุงูู ุชุญููู ุงูููู ูู [ููุง](https://raw.githubusercontent.com/Hussain-Alsalman/Arabian_Analyst_Blog/master/static/data/SAU_adm1.topojson)

### ูุชุงุจุฉ ุงููุงุฏ D3.js 

ูู ููุง ูุจุฏุฃ ุจูุชุงุจุฉ ุงููุงุฏ ุงูุฌุงูุง ุณูุฑูุจุช ูุฅุณุชุฎุฏุงู ููุชุจุฉ d3 ุงูุฑุงุฆุนุฉ
ุฎูููุง ูู ุงูุจุฏุงูุฉ ูุจุฏุฃ ุจูุถุน ูู ุงููุชุบูุฑุงุช ุงูุชู ุณูู ูุณุชุฎุฏููุง ูุตูุน ูุงูุฐุฉ ย[SVG](https://en.wikipedia.org/wiki/Scalable_Vector_Graphics) ยุนู ุทุฑูู ุชุญุฏูุฏ ุงูุทูู ูุงูุนุฑุถ. ุฃูุถุง ุณูุญุฏุฏยููุน ุงูุฅุณูุงุท ูุฎุงุฑุทุชูุง ููู ูู ูุฐู ุงูุญุงูุฉ [ุฅุณูุงุท ููุฑูุงุชูุฑ](https://ar.wikipedia.org/wiki/ุฅุณูุงุท_ูุฑูุงุชูุฑ). ุงูุถุง ุณูุถุน ูุชุบูุฑ ุจุฏูู ูููุฉ ููุญูู ูุนูููุงุช ุงูููู ูุงุญูุง.

```{js, eval = FALSE}
var height = 600;
var width = 750;
var projection = d3.geoMercator(); //defining the projection type function
var saudi = void 0 ;

```


ุงูุฌุฏูุฑ ุจุงูุฐูุฑุ ุฃูู ุนูุฏ ุฅุณุชุฎุฏุงู ููุชุจุฉ d3ุ ููููู ุชุนููู ูุชุบูุฑุงุช ูุชุญูู ุงูุชุญุฏูุฏ ุฐุงุชู [(CSS Selectors)](https://en.wikipedia.org/wiki/Cascading_Style_Sheets#Selector) ุญุชู ููู ูุงู ุนูุตุฑ ุงูููุจ ุงููุญุฏุฏ ุบูุฑ ููุฌูุฏ ูู ุงูุตูุญุฉ ูู ุญุงู ุงูุชุญุฏูุฏ.
ุงูุฎุทูุฉ ุงูุชุงููุฉ ูู ุตูุน ุงููุงูุฐุฉ (ุณูู ูุทูู ุนูููุง ููุญุฉ ุงูุฑุณู) ุงูุชู ูููุง ุจุชุญุฏูุฏ ุงูุชุฏุงุฏุงุชูุง.

```{js, eval = FALSE}
var svg = d3.select("#viz")
.append("svg")
.attr("width", width)
.attr("height", height)
.attr("id", "SVG");

```

ุณูู ูููู ุจูุชุงุจุฉ ุฏุงูุฉ ุชุชุฑุฌู ุงูุฅุณูุงุทุงุช ุฅูู ูุณุงุฑุงุช ุชุชุนุฑู ุนูููุง ุตูุญุงุช ุงูููุจ. ุณูู ูููู ุจุฅุณุชุฎุฏุงู ุชูู ุงูุฏุงูุฉ ูู ุญูููุง.

```{js, eval = FALSE}
var path = d3.geoPath(projection);
// End of Parameters
```

ุงุฑุฌู ุฃูู ูุณุชุนุฏ ูุฃูู ุณููููยุจุฅุณุชุนุฑุงุถ ุจููุฉ ุงูุฃููุงุฏ ุจุดูู ุงุณุฑุน. ุณูู ูุชุฌูุจ ุดุฑุญ ุงูุฃุฌุฒุงุก ุงูุฌูุงููุฉ ูุงูุบูุฑ ูุญูุฑูุฉ
ููุง ูููู ุจูุชุงุจุฉ ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ูุงูุชู ยุณูู ุชุญููยูุฌูู ุงูููุฏ ููุชุตููุฑ ุงูุจูุงูู ุงูุฐู ูุฃูู ุจู. ูุฐู ุงูุฏุงูุฉ ุณูู ุชููู ุจุงูุชุงูู:

1. ุชุญููู ุงูููู
2. ุชุญููููุง ุฅูู ุตูุบุฉ [GeoJSON](https://geojson.org/geojson-spec.html) ุนู ุทุฑูู ุฅุณุชุฎุฏุงู ููุชุจุฉ [Topojson.js](https://github.com/topojson/topojson/releases)ย
3. ุชุญุฏูุฏ ูููุงุณ ุงูุฑุณู ููุถุน ุงููุฑูุฒ ูู ููุทุฉ ุงูุฃุตู (ูู ุงูููุช ุงูุญุงูู)
4. ุญุณุงุจ ูููุงุณ ููุฑูุฒ ุงูุฎุงุฑุทุฉ ุงูููุงุณุจุงู ูุญุฌู ุงูุฎุฑูุทุฉ
5. ุฌูุน ูู ูุญุชูู ุงูุฎุฑูุทุฉ ูู ูุฌููุนุฉ ุณูุทูู ุนูููุง map
6. ุฑุณู ูู ูุญุชูู ุงูุฎุฑูุทุฉ ูุฅูุงู ุฏุงูุชูู ุฎุงุตุชูู ุจุนูููุฉ ุงูููุณ ุงู ุงููุฑูุฑ ุจุงููุงูุณ ูุงูุฎุฑูุฌ ุจุงููุงูุณ ุนูู ููุงุทู ุงูููููุฉ
7. ุญุณุงุจ ุงููุซุงูุงุช ุงูุณูุงููุฉ ุชูููู ุงูููุงุทู ูููุง ูุฐูู
8. ุฑุณู ุงููููุงุณ ูููุซุงูุฉ ุงูุณูุงููุฉ ููุฎุฑูุทุฉ
9. ุชูููู ูููุงุณ ุงูุฎุฑูุทุฉ

```{js, eval = FALSE}
//Main:
//1) Importing files 
    // We no longer import the data here, refer to the last section of this post to know why. 
  //2) Converting Files
  var states = topojson.feature(data,data.objects.sa);
  //3) Setting up scale and origin
  projection.scale(1).translate([0,0]);             
  //4) Algorithm for Calculating the Scale and Placement ("Translation")
  var b = path.bounds(states);
  var s = 0.95/Math.max((b[1][0]-b[0][0])/width,(b[1][1] - b[0][1]) / height);
  var t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s *(b[1][1] + b[0][1])) / 2];
  // Re-positioning the Map based on the newly calculated scale and center
  projection.scale(s).translate(t);

  //5) Setting up our map   
  var map = svg.append('g').attr('class', 'boundary');
  saudi = map.selectAll('path').data(states.features);

  //6) drawing the map
   saudi = saudi.enter()
      .append('path')
      .attr('d', path)
      .attr('id', geoID)
      .on('mouseover', hover)
      .on('mouseout',onout);

  // Update
  //7 calculating few important variables and color code the regions       
  var popMax  = d3.max(states.features,function(d)
                       {
                        return (d.properties.Population/d.properties.Area);
                       });
  var  popMin = d3.min(states.features,function(d)
                       {
                        return (d.properties.Population/d.properties.Area);
                       });
  var popMedian = d3.median(states.features,function(d)
                       {
                        return (d.properties.Population/d.properties.Area);
                       });

   var ScaleColor = d3.scaleLinear().domain([popMin,popMedian,popMax]).range(["yellow","orange","red"]);

  saudi.style('fill', function(d,i)
      {
          return ScaleColor((d.properties.Population/d.properties.Area))
        }
          );
  saudi
      .transition()
      .duration(500)
      .attr('fill', function(d)
      {
          return ScaleColor((d.properties.Population/d.properties.Area));
      });
           
  //9 Other cosmatic stuff       
  var svgDefs = svg.append('defs');
  var mainGradient = svgDefs.append('linearGradient').attr('id', 'mainGradient');
                  
          mainGradient.append('stop')
              .style('stop-color', ScaleColor(0))
              .attr('offset', '0');
          mainGradient.append('stop')
              .style('stop-color', ScaleColor(popMax))
              .attr('offset', '1');
  // 10 drawing the scale
          var gh = height/100;
          var gw = width/5;
          var gp = 3;
          var ruler = svg.append("g").attr("id", "ruler");
          ruler.attr("transform","translate(" + (width*0.75) + "," + (height*0.10)+")");
          ruler.append('rect')
              .style('fill', "url(#mainGradient)")
              .attr('width', gw)
              .attr('height', gh);
             var xScale = d3.scaleLinear().domain([0,popMax]).range([0,(width/5)]);
             var xAxis = d3.axisBottom(xScale)
                          .tickValues([0,(popMax/4),(popMax/2),(3*popMax/4),popMax])
                          .tickFormat(d3.format("f"));
                           
             ruler.attr("class", "axis").append("text").attr("y", -10).text("ุนุฏุฏ ุงูุณูุงู ููู ูููู ูุชุฑ ูุฑุจุน")
             .attr("transform","translate("+gw*.5+",0)");
            ruler.attr("class", "axis").call(xAxis);

```



ูู ุฏุงูุฉ ุงููุฑูุฑ ุจุงููุงูุณ ุณูู ูููู ุจุงูุชุงูู

1. ุชุบูุฑ ูุณุชูู ุดูุงููุฉ ุงูุฃููุงู ููู ูููุทูุฉ ูุง ุนุฏุง ุงููููุทูุฉ ุงูููุนููุฉ
2. ุฅุณุชุฎุฑุงุฌ ุฌุฒุก ูู ุงูุจูุงูุงุช ูุฅุนุงุฏุฉ ุชุฑุชูุจู
3. ุฅุฏุฑุงุฌ ูุฌููุนุฉ ูู ุนูุงุตุฑ ุงูููุจ ููุฅุถุงูุฉ ุงูุฑุณู ุงูุจูุงูู ุงูุฎุงุต ุจุชุตุงููู ุงูุณูุงู ูุงุฌูุงุณูู
4. ุฑุณู ุงูุฃุนูุฏุฉ ุงูุจูุงููุฉ ูุฅุถุงูุฉ ุงูุจูุงูุงุช.


```{js, eval = FALSE}

var hover = function(data) {
  //M 1
      saudi.attr('fill-opacity', 0.2);// Another Updates
      d3.select('#'+geoID(data)).attr('fill-opacity',1);
      d3.select(".axis text").text(data.properties.Province_Name).attr('fill', 'black')
     
  //M 2     
      var englishLables = ["All_Males",
                  "All_Females",
                  "Expat_Males",
                  "Expat_Females",
                  "Saudi_Males",
                  "Saudi_Females"];
      var arabicLabels =  ["ุงูุฐููุฑ",
                  "ุงูุฅูุงุซ",
                  "ุงูุฐููุฑ ุงูุฃุฌุงูุจ",
                  "ุงูุฅูุงุซ ุงูุฃุฌุงูุจ",
                  "ุงูุฐููุฑ ุงูุณุนูุฏููู",
                  "ุงูุฅูุงุซ ุงูุณุนูุฏููู"];
                   
                   
      stat = englishLables.map(function (i){ return parseInt(data.properties[i]); });
  //M 3               
      svg.append("g").attr("id", "barChart").attr("transform","translate(" +width*.75+",98)");
      xscale = d3.scaleLinear().domain([0,(stat[0]+stat[1])]).range([0,200]);
       
      var drwaring = d3.select('#barChart').selectAll("rect").data(stat);
      var labels = d3.select('#barChart').selectAll("text").data(stat); 

  //M 4   
             drwaring = drwaring
              .enter()
              .append("rect")
              .attr("height",15)
              .attr("width", 0)
              .attr("x", function(d){return 0})
              .attr("y",function(d,i){ return ( i * 20)})
              .style("fill", function(d,i){
                  if(i%2 === 0){ return  "lightblue"}
                                      else {return  "pink"}              
              })
              drwaring
              .transition().duration(1000).ease(d3.easeQuad)
              .attr("width",  function(d){ return xscale(d) })
   
   
          var formatPercent = d3.format(",.2r");         
               
          labels
              .enter()
              .append("text")
              .style("font-size", 10).style('color', 'black')
              .attr("y",function(d,i){ return i*20+10}) 
              .transition().duration(1000)
              .attr("x", function(d){return xscale(d)+5})
              .tween("text",function(d,a) {
                      var i = d3.interpolate(0,d);
                      var node= d3.select(this);
                      return function(t) {
                      node.text(formatPercent(i(t)/1000000) + " ููููู" ) };})

         labels
              .enter()
              .append("text")
              .style("font-size", 10).style('color', 'black')
              .attr("text-anchor", "end") 
              .attr("x", -10)
              .attr("y",function(d,i){ return i*20+10})
              .text(function(d,i){return arabicLabels[i]})
          };

```

ูู ุฏุงูุฉ ุฎุฑูุฌ ุงููุงูุณ ุณูู ูููู ุจุงูุชุงูู

1. ุฅุนุงุฏุฉ ูุณุชูู ุดูุงููุฉ ุฌููุน ุงูููุงุทู ุฅูู ุญุงููุง ุงูุณุงุจู
2. ูุฅุนุงุฏุฉ ุฅุนุฏุงุฏุงุช ูููุงุณ ุงูุฎุฑูุทุฉ
3. ู ุฅุฒุงูุฉ ุขุนูุฏุฉ ุงูุฑุณู ุงูุจูุงูู

```{js, eval = FALSE}
var onout = function(d){
    //MO 1
    saudi.attr('fill-opacity', 1);
    //MO 2
    d3.select(".axis text").text("ุนุฏุฏ ุงูุณูุงู ููู ูููู ูุชุฑ ูุฑุจุน");
    //MO 3
    d3.select('#barChart').remove();}
   
```




```{r, echo=FALSE,message=FALSE,warning=FALSE}
#install.packages("geojsonio")
library("sf")
library("geojsonio")
library("readxl")
library("magrittr")
library("dplyr")
library("jsonlite")
library("here")

```


```{r, echo=FALSE,message=FALSE,warning=FALSE}
filename <- here("static", "data", "data.xlsx")
sa <-topojson_read(x = here("static", "data", "SAU_adm1.topojson"))
saudi_data <-read_excel(path =filename,range = "A6:K18", col_names = c(
  "adm_area", 
  "occupied_units", 
  "Saudi_Males",
  "Saudi_Females",
  "All_Saudis",
  "Expat_Males",
  "Expat_Females",
  "All_Expats",
  "All_Males",
  "All_Females",
  "Population")) %>%  arrange(match(adm_area,sa$NAME_1))
```

```{r, echo=FALSE,message=FALSE,warning=FALSE}

for(col_name in colnames(saudi_data)){
  if(col_name %in% colnames(sa)) {
    sa[col_name] = saudi_data[col_name]
  }else{
    next
  }
}

topo_sa <- topojson_json(sa,object_name = "sa")
```

```{r, results="asis",echo=FALSE,message=FALSE,warning=FALSE}
  cat(
    paste(
    '<script>
      var data = ',topo_sa,';
    </script>'
    , sep="")
  ) 
```

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://unpkg.com/topojson@3.0.2/dist/topojson.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-format.v1.min.js"></script>


<div id = "viz"></div> 
```{css,echo=FALSE,message=FALSE,warning=FALSE}

.filled {
    fill: url(#mainGradient);
}
.axis text {
  color: black;
  text-align: center;
}

```

```{js, results = "asis",  echo=FALSE,message=FALSE,warning=FALSE}
window.saudi = void(0) ;
window.svg = void(0);
var geoID = function(d){
    return "c" + d.properties.ID_1;
};

// End of Parameters

var hover = function(data) {
  //M 1
      saudi.attr('fill-opacity', 0.2);// Another Updates
      d3.select('#'+geoID(data)).attr('fill-opacity',1);
      d3.select(".axis text").text(data.properties.Province_Name).attr('fill', 'black')
     
  //M 2     
      var englishLables = ["All_Males",
                  "All_Females",
                  "Expat_Males",
                  "Expat_Females",
                  "Saudi_Males",
                  "Saudi_Females"];
      var arabicLabels =  ["ุงูุฐููุฑ",
                  "ุงูุฅูุงุซ",
                  "ุงูุฐููุฑ ุงูุฃุฌุงูุจ",
                  "ุงูุฅูุงุซ ุงูุฃุฌุงูุจ",
                  "ุงูุฐููุฑ ุงูุณุนูุฏููู",
                  "ุงูุฅูุงุซ ุงูุณุนูุฏููู"];
                   
                   
      stat = englishLables.map(function (i){ return parseInt(data.properties[i]); });
  //M 3               
      svg.append("g").attr("id", "barChart").attr("transform","translate(" +width*.75+",98)");
      xscale = d3.scaleLinear().domain([0,(stat[0]+stat[1])]).range([0,200]);
       
      var drwaring = d3.select('#barChart').selectAll("rect").data(stat);
      var labels = d3.select('#barChart').selectAll("text").data(stat); 

  //M 4   
             drwaring = drwaring
              .enter()
              .append("rect")
              .attr("height",15)
              .attr("width", 0)
              .attr("x", function(d){return 0})
              .attr("y",function(d,i){ return ( i * 20)})
              .style("fill", function(d,i){
                  if(i%2 === 0){ return  "lightblue"}
                                      else {return  "pink"}              
              })
              drwaring
              .transition().duration(1000).ease(d3.easeQuad)
              .attr("width",  function(d){ return xscale(d) })
   
   
          var formatPercent = d3.format(",.2r");         
               
          labels
              .enter()
              .append("text")
              .style("font-size", 10).style('color', 'black').attr("text-anchor", "end") 
              .attr("y",function(d,i){ return i*20+10}) 
              .transition().duration(1000)
              .attr("x", function(d){return xscale(d)+xscale(65)})
              .tween("text",function(d,a) {
                      var i = d3.interpolate(0,d);
                      var node= d3.select(this);
                      return function(t) {
                      node.text(formatPercent(i(t)/1000000) + " ููููู" ) };})

         labels
              .enter()
              .append("text")
              .style("font-size", 10).style('color', 'black')
              
              .style("text-align","right")
              .attr("x", -1*(width*0.01))
              .attr("y",function(d,i){ return i*20+10})
              .text(function(d,i){return arabicLabels[i]})
          };

// Mouse out       
      var onout = function(d){
          //MO 1
          saudi.attr('fill-opacity', 1);
          //MO 2
          d3.select(".axis text").text("ุนุฏุฏ ุงูุณูุงู ููู ูููู ูุชุฑ ูุฑุจุน");
          //MO 3
          d3.select('#barChart').remove();}
   
var drawme = function(){
//Main:
 
//1) Setting Parameters
  var projection = d3.geoMercator(); //defining the projection type function
  var path = d3.geoPath(projection);
  window.width = document.getElementById("viz").clientWidth;
  window.height =  width*0.8
  svg = d3.select("#viz")
              .append("svg")
              .attr("width", width)
              .attr("height", height)
              .attr("id", "SVG");
      
            //2) Converting Files
            var states = topojson.feature(data,data.objects.sa);
            //3) Setting up scale and origin
            projection.scale(1).translate([0,0]);             
            //4) Algorithm for Calculating the Scale and Placement ("Translation")
            var b = path.bounds(states);
            var s = 0.95/Math.max((b[1][0]-b[0][0])/width,(b[1][1] - b[0][1]) / height);
            var t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s *(b[1][1] + b[0][1])) / 2];
            // Re-positioning the Map based on the newly calculated scale and center
            projection.scale(s).translate(t);
 
            //5) Setting up our map   
            var map = svg.append('g').attr('class', 'boundary');
            saudi = map.selectAll('path').data(states.features);
 
            //6) drawing the map
             saudi = saudi.enter()
                .append('path')
                .attr('d', path)
                .attr('id', geoID)
                .on('mouseover', hover)
                .on('mouseout',onout);

            // Update
            //7 calculating few important variables and color code the regions       
            var popMax  = d3.max(states.features,function(d)
                                 {
                                  return (d.properties.Population/d.properties.Area);
                                 });
            var  popMin = d3.min(states.features,function(d)
                                 {
                                  return (d.properties.Population/d.properties.Area);
                                 });
            var popMedian = d3.median(states.features,function(d)
                                 {
                                  return (d.properties.Population/d.properties.Area);
                                 });

             var ScaleColor = d3.scaleLinear().domain([popMin,popMedian,popMax]).range(["#D3DDA0","#E18942","#650022"]);
 
            saudi.style('fill', function(d,i)
                {
                    return ScaleColor((d.properties.Population/d.properties.Area))
                  }
                    );
            saudi
                .transition()
                .duration(500)
                .attr('fill', function(d)
                {
                    return ScaleColor((d.properties.Population/d.properties.Area));
                });
                     
            //9 Other cosmatic stuff       
            var svgDefs = svg.append('defs');
            var mainGradient = svgDefs.append('linearGradient').attr('id', 'mainGradient');
                            
                    mainGradient.append('stop')
                        .style('stop-color', ScaleColor(0))
                        .attr('offset', '0');
                    mainGradient.append('stop')
                        .style('stop-color', ScaleColor(popMax))
                        .attr('offset', '1');
            // 10 drawing the scale
                    var gh = height/100;
                    var gw = width/5;
                    var gp = 3;
                    var ruler = svg.append("g").attr("id", "ruler");
                    ruler.attr("transform","translate(" + (width*0.75) + "," + (height*0.10)+")");
                    ruler.append('rect')
                        .style('fill', "url(#mainGradient)")
                        .attr('width', gw)
                        .attr('height', gh);
                       var xScale = d3.scaleLinear().domain([0,popMax]).range([0,(width/5)]);
                       var xAxis = d3.axisBottom(xScale)
                                    .tickValues([0,(popMax/4),(popMax/2),(3*popMax/4),popMax])
                                    .tickFormat(d3.format(".0f"));
                                     
                       ruler.attr("class", "axis").append("text").attr("y", -10).text("ุนุฏุฏ ุงูุณูุงู ููู ูููู ูุชุฑ ูุฑุจุน")
                       .attr("transform","translate("+gw*.5+",0)");
                      ruler.attr("class", "axis").call(xAxis);

}
var resize = function(){
  d3.select("#SVG").remove();
  drawme();
}
drawme();
window.onresize = resize;
//Call our resize function if the window size is changed.
```




### ุชุญุฏูุซ ููุฐุง ุงูููุงู 
ูุฐุง ุงูููุงู ุชู ูุชุงุจุชู ูขููกูฆ ูุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูู ููู json ูุฏููุฉ. ูุฐูู ุงุณูู ูููู ุจุชุญุฏูุซ ุงูุจูุงูุงุช ุนู ุทุฑูู ุงูุขุฑ . ูุฐู ุงูุฃููุงุฏ ุชููู ุจุนุฏ ุนูููุฉ ุชุญููู ุงููููุงุช ุฅูู topojson 


ููุง ููุฑุฃ ุงูููู ููุญุฏุฏ ููุน ุงูุฃุนูุฏุฉ ุชุญุถูุฑุง ููุชุญุฏูุซ 

```{r,eval=FALSE}
filename <- "data.xlsx"
download.file("https://www.stats.gov.sa/sites/default/files/twzy_lskn_fy_lmnzq_ldry.xlsx", destfile = filename)
sa <-topojson_read(here("static", "data", "SAU_adm1.topojson"))
saudi_data <-read_excel(path =filename,range = "A6:K18", col_names = c(
  "adm_area", 
  "occupied_units", 
  "Saudi_Males",
  "Saudi_Females",
  "All_Saudis",
  "Expat_Males",
  "Expat_Females",
  "All_Expats",
  "All_Males",
  "All_Females",
  "Population")) %>%  arrange(match(adm_area,sa$NAME_1))

```


ููุง ูุญุฏุซ ุงูุจูุงูุงุช ูููุง'
```{r,eval=FALSE}

for(col_name in colnames(saudi_data)){
  if(col_name %in% colnames(sa)) {
    sa[col_name] = saudi_data[col_name]
  }else{
    next
  }
}

topo_sa <- topojson_json(sa,object_name = "sa")
```

ููุง ูุฌุนู ุงูุจูุงูุงุช  ูุชููุฑุฉ ูู ุจูุฆุฉ ุฌุงูุง ุณูุฑูุจุช 

```{r,eval=FALSE}
  cat(
    paste(
    '<script>
      var data = ',topo_sa,';
    </script>'
    , sep="")
  ) 
```

ุจุฐูู ูููู ุฎุทูุฉ ุงูุชุญุฏูุซ ููุง. ูุง ููุฌุฏ ุงู ุชุญุฏูุซุงุช ุงุฎุฑู ูุจููุฉ ุงูููุงู ูุง ุนุฏุง ุงูุชุญุฏูุซุงุช ููุฃููุงุฏ.  